---
import '@src/styles/article.css'
import BaseLayout from "./BaseLayout.astro";
const {title, backlinks, description} = Astro.props;

const lastBacklink = backlinks?.[backlinks.length - 1]

import { marked, Marked } from 'marked';
import markedPlaintify from 'marked-plaintify'
const mdTitle = marked.parse(title).replaceAll(/<\/?p>/gi, '')
const plainTitle = new Marked()
  .use(markedPlaintify())
  .parse(title)
---

<BaseLayout title={plainTitle}>
  <div class="content" id="article">
    <div class="page-intro">
      <h1 class="page-title konsole">
        <span set:html={mdTitle}/>
        {backlinks?.length > 0 &&
          <span class="tags">
            {"("}{backlinks.slice(0, -1).map(({name, url}) => <span><a href={url}>{name}</a>, </span>)}<span><a href={lastBacklink.url}>{lastBacklink.name}</a></span>{")"}
          </span>
        }
      </h1>
      <!-- {description && <p class="page-description konsole">{description}</p>} -->
    </div>
    <slot />
  </div>
</BaseLayout>

<script>
  const captions = document.querySelectorAll('.caption');
  captions.forEach(caption => {
    let prevSibling = caption.previousElementSibling;
    while (prevSibling) {
      if (prevSibling instanceof HTMLScriptElement) {
        prevSibling = prevSibling.previousElementSibling;
      } else if ((prevSibling instanceof HTMLAnchorElement) || (prevSibling instanceof HTMLSpanElement)) {
        prevSibling = prevSibling.children[prevSibling.children.length - 1];
        continue
      } else break
    }
    if (prevSibling) {
      prevSibling.classList.add('captioned');
    }
  });
</script>