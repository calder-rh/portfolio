---
import '@src/styles/global.css';
import '@src/styles/home.css';
import BaseLayout from 'src/layouts/BaseLayout.astro';
import TextOval from '@src/layouts/TextOval.astro';

import WorkItem from "@src/components/WorkItem.astro"

import { getCollection, render } from 'astro:content'
import WorkTag from "@src/components/WorkTag.astro"
import { inferTags } from '@src/scripts/utilities.js'

const allItems = await getCollection('items')

const workItems = allItems.filter((item) => item.data.home.includes('work'))
const tagItems = allItems.filter((item) => item.data.home.includes('tag'))

const workItemData = []


for (let item of workItems) {
  const workItem = {
    title: item.data.name,
    description: item.data.description,
    tags: await inferTags(item.data.tags.map(item => item.id), item.data.unlisted),
    unlisted: item.data.unlisted,
    date: item.data.dat?.end.date,
    priority: item.data.priority,
    draft: item.data.draft === true,
		id: item.id,
    slug: `work/${item.id}`,
		rows: item.data.rows,
    slides: item.data.slides,
  }
  workItemData.push(workItem)
}

const orderedTags = [
  'all',
  'art',
  'design',
  'code',
  'writing-systems',
  'encoding-systems',
  'lettering',
  'type',
  '3d',
  'music-visualization',
  'generative-art',
  'photography',
]


const sortedTags = Array.from(tagItems).sort((a, b) => {
  if (a.data.unlisted != b.data.unlisted) return b.data.unlisted - a.data.unlisted
  return orderedTags.indexOf(a.id) - orderedTags.indexOf(b.id)
})

const renderedIntros =  await Promise.all(tagItems
	.filter((tag) => !tag.data.home.includes('work'))
	.map(async (tag) => {
		const { Content } = await render(tag);
		return { slug: tag.id, content: Content }
}))
---

<BaseLayout title="Calder Ruhl Hansen" name={false}>
	<div id="intro-container" class="closed no-transition">
		<TextOval squareness={38} id="intro">
			<p>
				Hi, Iâ€™m Calder. I make systems of meaningful forms. Or sometimes just systems, or forms, or things that feel meaningful.
			</p>
		</TextOval>
	</div>

	<div id="top-tag-separator" class="closed"></div>
	<div id="tags">
    {sortedTags.map(tag => <WorkTag listName={tag.data.name} titleName={tag.data.title} slug={tag.id} unlisted={tag.data.unlisted}></WorkTag>)}
  </div>
  <div id="tag-separator">
    <div id="tag-intro-container">
      <div id="tag-intro-current" />
      <div id="tag-intro-incoming" />
      <div id="tag-intro-waiting-room">
        {renderedIntros.map((item) => 
          <div class="tag-intro " data-slug={item.slug}>
            <item.content />
          </div>
        )}
      </div>
    </div>
  </div>
	<!-- <Columns id="work-cols" columnWidth={600} columnGap={20} prepareItems={false} fillColumns={false}></Columns> -->
  <div id="waiting-room">
    {workItemData.map((data) => <WorkItem data={data}/>)}
  </div>
  <div id="work-cols"></div>
</BaseLayout>

<script>
  import '@src/scripts/work.js'
</script>
