---
import type { ImageMetadata } from 'astro';
import { Image } from "astro:assets";

const {
  src,
  slug: imgSlug,
  alt,
  width,
  scale,
  id,
  classes=[],
  format='png'
} = Astro.props;

const { slug: pageSlug } = Astro.params
const slug = imgSlug ?? pageSlug

console.log(slug)

const classList = ["img"]
if (scale) classList.push("scaled unsized")
if (classes) classList.push(...classes)
const classesUsed = classList.join(" ")

const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/**/*.{jpeg,jpg,png,gif,svg}')

//TODO: this doesn’t work with work embeds… need to maybe hae some way to set the slug in props?
const imagePath = (() => {
  if (src.match(/^~\//)) return `/src/assets/${src.slice(1)}`
  else if (src.match(/^\//)) return `/src/assets/work${src}`
  else return `/src/assets/work/${slug}/${src}`}
)()

if (!images[imagePath]) throw new Error(`"${imagePath}" does not exist in glob: "/src/assets/**/*.{jpeg,jpg,png,gif,svg}"`);
---

<div class={classesUsed} id={id} data-scale={scale}>
  <Image src={images[imagePath]()} width={width} alt={alt} format={format} loading="lazy"/>
</div>

<script>
  document.querySelectorAll(".img.scaled").forEach(img_container => {
    const img = img_container.querySelector("img")
    fetch(img.src)
      .then(r => r.text())
      .then(text => {
        const m = text.match(/viewBox\s*=\s*"([^"]+)"/i);
        if (!m) return;

        const [minX, minY, w, h] = m[1].split(/\s+/).map(Number);
        const scale = img_container.dataset.scale * 0.01;

        img.style.width = (w * scale) + "rem";
        img.style.height = "auto";
      });
      img_container.classList.toggle("unsized", false);
    });
</script>