---
// import { Image } from "astro:assets"
import Img from "@src/components/Img.astro"
import Cap from "./Cap.astro"
import random from "@src/scripts/random"
import { marked } from 'marked'

const { data } = Astro.props
const { title, description, tags, rows, slides, draft, unlisted, id, slug } = data
const minHeight = 0.6 + title.length / 80
const url = `/${slug}`

const contextRows = (() => {
  if (rows === undefined) return undefined

  const contextRows = rows.map(
    (row) => (row.map(
      (image) => ({path: image, contexts: []}))
    )
  )
  for (let image of contextRows[0]) {image.contexts.push("work top")}
  for (let image of contextRows[contextRows.length - 1]) {image.contexts.push("work bottom")}
  for (let row of contextRows) {
    if (row.length == 1) {row[0].contexts.push("work row")}
  }

  return contextRows
})()

const orderedSlides = (() => {
  if (slides === undefined) return undefined

  const firstArray = []

  if (slides.first.length > 0) {
    const firstIndex = Math.floor(random(0, slides.first.length))
    firstArray.push(slides.first[firstIndex])
    slides.first.splice(firstIndex, 1)
  }

  const restArray = slides.first.concat(slides.rest)
  const shuffledRest = restArray
    .map(value => ({ value, sort: Math.random() }))
    .sort((a, b) => a.sort - b.sort)
    .map(({ value }) => value)

  return firstArray.concat(shuffledRest)
})()

const classList = ["work-item no-rise"]
if (draft) classList.push("draft")
if (unlisted) classList.push("unlisted")
---

<div class:list={classList} data-data={JSON.stringify(data)} data-tags={JSON.stringify(tags)} data-minHeight={`${minHeight}`} style=`--min-width: ${random(0.05, 0.07)}; --min-height: ${minHeight}rem; --work-item-color: var(--offwhite)`>
  <div class="work-item-scaler">
    <Cap side="top" squareness={38} url={draft ? null : url}></Cap>
    <div class="work-content-wrapper">
      <div class="work-content konsole">
        {!draft && <a class="work-link no-rise" href={url}/>}
        <h3 class="work-title work-text">{
          (() => {
            const mdTitle = marked.parse(title).replaceAll(/<\/?p>/gi, '')
            if (draft) return <span class="work-title-contents" set:html={mdTitle} />
            else return <a href={url} class="work-url work-title-contents" set:html={mdTitle} />
          })()
        }</h3>
        {description && <p class="work-description work-text">{description}</p>}
        {draft && <p class="coming-soon">coming soon</p>}
        <div class="work-images">
          {contextRows &&
            <div class="work-rows">
              {contextRows.map((row) => 
                <div class="work-row">
                  {row.map(({path, contexts}) =>
                    <div class="work-image">
                      <Img slug={id} src={path} res={500} context={contexts}/>
                    </div>)}
                </div>)}
            </div>
          }
          {orderedSlides &&
            <div class="work-slides">
              {orderedSlides.map((path, index) =>
                <div class:list={["work-image"].concat(index === 0 ? [""] : ["closed"])}>
                  <Img slug={id} src={path} res={500} context={["work top", "work bottom", "work row"]}/>
                </div>)}
            </div>
          }
        </div>
      </div>
    </div>
    <Cap side="bottom" squareness={35} url={draft ? null : url}></Cap>
  </div>
</div>